<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/app/dashboardView/desktop/desktop.js - ozpwebtop</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="ozpwebtop"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.1.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/appLauncher.AppLauncherCtrl.html">appLauncher.AppLauncherCtrl</a></li>
            
                <li><a href="../classes/appToolbar.ApplicationToolbarCtrl.html">appToolbar.ApplicationToolbarCtrl</a></li>
            
                <li><a href="../classes/appToolbar.appToolbar.html">appToolbar.appToolbar</a></li>
            
                <li><a href="../classes/common.windowSizeWatcher.html">common.windowSizeWatcher</a></li>
            
                <li><a href="../classes/constants.html">constants</a></li>
            
                <li><a href="../classes/dashboardToolbar.dashboardToolbar.html">dashboardToolbar.dashboardToolbar</a></li>
            
                <li><a href="../classes/dashboardToolbar.DashboardToolbarCtrl.html">dashboardToolbar.DashboardToolbarCtrl</a></li>
            
                <li><a href="../classes/dashboardView.ChromeCtrl.html">dashboardView.ChromeCtrl</a></li>
            
                <li><a href="../classes/dashboardView.DesktopCtrl.html">dashboardView.DesktopCtrl</a></li>
            
                <li><a href="../classes/dashboardView.GridCtrl.html">dashboardView.GridCtrl</a></li>
            
                <li><a href="../classes/dashboardView.IframeCtrl.html">dashboardView.IframeCtrl</a></li>
            
                <li><a href="../classes/dashboardView.ozpButton.html">dashboardView.ozpButton</a></li>
            
                <li><a href="../classes/dashboardView.ozpChrome.html">dashboardView.ozpChrome</a></li>
            
                <li><a href="../classes/dashboardView.ozpGridsterItem.html">dashboardView.ozpGridsterItem</a></li>
            
                <li><a href="../classes/dashboardView.ozpManagedFrame.html">dashboardView.ozpManagedFrame</a></li>
            
                <li><a href="../classes/general.dashboardChangeMonitor.html">general.dashboardChangeMonitor</a></li>
            
                <li><a href="../classes/general.iwcInterface.html">general.iwcInterface</a></li>
            
                <li><a href="../classes/general.localStorageInterface.html">general.localStorageInterface</a></li>
            
                <li><a href="../classes/models.dashboardApi.html">models.dashboardApi</a></li>
            
                <li><a href="../classes/models.marketplaceApi.html">models.marketplaceApi</a></li>
            
                <li><a href="../classes/models.userSettingsApi.html">models.userSettingsApi</a></li>
            
                <li><a href="../classes/ozp.common.compareUrl.html">ozp.common.compareUrl</a></li>
            
                <li><a href="../classes/ozp.common.elliptical.html">ozp.common.elliptical</a></li>
            
                <li><a href="../classes/ozp.common.iwcConnectedClient.html">ozp.common.iwcConnectedClient</a></li>
            
                <li><a href="../classes/ozp.common.LocalStorage.html">ozp.common.LocalStorage</a></li>
            
                <li><a href="../classes/ozp.common.Utilities.html">ozp.common.Utilities</a></li>
            
                <li><a href="../classes/userSettings.ModalInstanceCtrl.html">userSettings.ModalInstanceCtrl</a></li>
            
                <li><a href="../classes/userSettings.userSettings.html">userSettings.userSettings</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/ozp.common.html">ozp.common</a></li>
            
                <li><a href="../modules/ozpWebtopApp.html">ozpWebtopApp</a></li>
            
                <li><a href="../modules/ozpWebtopApp.appLauncher.html">ozpWebtopApp.appLauncher</a></li>
            
                <li><a href="../modules/ozpWebtopApp.appToolbar.html">ozpWebtopApp.appToolbar</a></li>
            
                <li><a href="../modules/ozpWebtopApp.constants.html">ozpWebtopApp.constants</a></li>
            
                <li><a href="../modules/ozpWebtopApp.dashboardToolbar.html">ozpWebtopApp.dashboardToolbar</a></li>
            
                <li><a href="../modules/ozpWebtopApp.dashboardView.html">ozpWebtopApp.dashboardView</a></li>
            
                <li><a href="../modules/ozpWebtopApp.general.html">ozpWebtopApp.general</a></li>
            
                <li><a href="../modules/ozpWebtopApp.models.html">ozpWebtopApp.models</a></li>
            
                <li><a href="../modules/ozpWebtopApp.userSettings.html">ozpWebtopApp.userSettings</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: src/app/dashboardView/desktop/desktop.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x27;use strict&#x27;;

angular.module(&#x27;ozpWebtopApp.dashboardView&#x27;)
/**
 * Controller for managing apps/widgets in desktop layout on a dashboard
 *
 * ngtype: controller
 *
 * @class DesktopCtrl
 * @constructor
 * @param $scope ng $scope
 * @param $rootScope ng $rootScope
 * @param $location ng $location
 * @param dashboardApi dashboard data
 * @param marketplaceApi marketplace listings data
 * @param dashboardChangeMonitor notify when dashboard changes
 * @param userSettingsApi user preferences data
 * @param dashboardStateChangedEvent event name
 * @param toolbarVisibilityChangedEvent event name
 * @namespace dashboardView
 */
  .controller(&#x27;DesktopCtrl&#x27;, function ($scope, $rootScope, $location,
                                       dashboardApi, marketplaceApi,
                                       dashboardChangeMonitor,
                                       userSettingsApi,
                                       dashboardStateChangedEvent,
                                       toolbarVisibilityChangedEvent) {

    // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
    //                            $scope properties
    // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

    /**
     * @property dashboards User&#x27;s dashboards
     * @type {Array}
     */
    $scope.dashboards = [];

    /**
     * @property frames Frames on the dashboard (widget instances)
     * @type {Array}
     */
    $scope.frames = [];

    /**
     * @property dashBarHidden Flag indicating whether the dashboard toolbar
     * is hidden
     * @type {boolean}
     */
    $scope.dashBarHidden = false;

    /**
     * @property appBarHidden Flag indicating whether the application toolbar
     * is hidden
     * @type {boolean}
     */
    $scope.appBarHidden = false;

    /**
     * @property apps Applications in the marketplace
     * TODO: only need the data for apps user has favorited
     * @type {Array}
     */
    $scope.apps = [];

    /**
     * @property currentDashboard Active dashboard
     * @type {string}
     */
    $scope.currentDashboard = &#x27;&#x27;;

    /**
     * @property currentDashboardId Active dashboard id
     * @type {string}
     */
    $scope.currentDashboardId = &#x27;&#x27;;

    /**
     * @property max TODO define this
     * @type {{}}
     */
    $scope.max = {};

    // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
    //                           initialization
    // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

    // register to receive notifications when active dashboard changes
    dashboardChangeMonitor.run();

    // get dashboards
    dashboardApi.getDashboards().then(function(dashboards) {
      if (!dashboards) {
        console.log(&#x27;No dashboards exist&#x27;);
        return;
      }
      console.log(&#x27;re getting dasboards&#x27;);
      $scope.dashboards = dashboards;

      $scope.frames = $scope.dashboards[0].frames;  // to make tests happy
    }).catch(function(error) {
      console.log(&#x27;should not have happened: &#x27; + error);
    });

    // get application listings
    marketplaceApi.getAllApps().then(function(apps) {
      $scope.apps = apps;
    }).catch(function(error) {
      console.log(&#x27;should not have happened: &#x27; + error);
    });

    $scope.$on(toolbarVisibilityChangedEvent, function() {
      handleToolbarVisibilityChange();
    });

    $scope.$on(dashboardStateChangedEvent, function() {
      dashboardChangeHandler();
    });

    // TODO: First tried sending broadcast events from dashboardChangeMonitor,
    // but that did not work out - led to lots of problems such as the desktop
    // and grid controllers not being loaded/unloaded properly. So instead, we&#x27;ll
    // just reach into the internal state of the dashboardChangeMonitor to get
    // this info and use $watch on $location.path to trigger the update. To
    // see what happens, just uncomment the console.logs in $on.(...) in
    // grid.js and desktop.js
    $scope.$watch(function() {
      return $location.path();
    }, function() {
      updateDashboard();
    });

    // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
    //                          methods
    // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

    /**
     * Handler invoked when a toolbarVisibilityChangedEvent is received
     *
     * @method handleToolbarVisibilityChange
     */
    function handleToolbarVisibilityChange() {
      userSettingsApi.getUserSettings().then(function(settings) {
        if (settings.isDashboardHidden === true) {
          $scope.dashBarHidden = true;
        } else {
          $scope.dashBarHidden = false;
        }

        if (settings.isAppboardHidden === true) {
          $scope.appBarHidden = true;
        } else {
          $scope.appBarHidden = false;
        }
      }).catch(function(error) {
        console.log(&#x27;should not have happened: &#x27; + error);
      });
    }

    /**
     * Handler invoked when a dashboardStateChangedEvent is received
     *
     * @method dashboardChangeHandler
     */
    function dashboardChangeHandler() {
      /* isminimized */
      dashboardApi.getDashboards().then(function(dashboards) {
        var apiDash = {};
        for (var ii=0; ii &lt; dashboards.length; ii++) {
          if (dashboards[ii].id === dashboardChangeMonitor.dashboardId) {
            apiDash = dashboards[ii];
          }
        }
        for (var z in apiDash.frames){
          for (var y in $scope.frames){
            if ((apiDash.frames[z].id === $scope.frames[y].id) &amp;&amp; (apiDash.frames[z].isMinimized !== $scope.frames[y].isMinimized)) {
              $scope.frames[y].isMinimized = apiDash.frames[z].isMinimized;
              //
            }
            if((apiDash.frames[z].id === $scope.frames[y].id) &amp;&amp; (apiDash.frames[z].isMaximized !== $scope.frames[y].isMaximized)) {
              $scope.frames[y].isMaximized = apiDash.frames[z].isMaximized;
              //
            }
          }
        }

        /* end isminimized */
        if ($scope.frames.length !== apiDash.frames.length){

          /* Make an array of old frames and new frames */
          var oldFrames = [],
              newFrames = [];
          for(var i in $scope.frames){
            oldFrames.push($scope.frames[i].id);
          }

          for (var j in apiDash.frames){
            newFrames.push(apiDash.frames[j].id);
          }

          /* return just the differences between oldFrames and new Frames */
          Array.prototype.diff = function(a) {
            return this.filter(function(i) {return a.indexOf(i) &lt; 0;});
          };
          // add or remove new frames without reloading the entire scope
          // if there are items in the currentScope that are not in the updated
          // scope from the service, remove theme here
          if (oldFrames.diff(newFrames).length &gt; 0){
            for (var a = 0; a &lt; $scope.frames.length; a++){
              // if the removed frame is present, splice it out of the local
              // scope
              if ($scope.frames[a].id === oldFrames.diff(newFrames)[0]){
                $scope.frames.splice(a, 1);
              }
            }
          }
          // if there are new frames for this dashboard on the services that are
          // not in the local scope
          if (newFrames.diff(oldFrames).length &gt; 0){

            // for item in the dashboardApi on the current Dashboard
            for (var b = 0; b &lt; apiDash.frames.length; b++){

              // if the item from the dashboard api matches the new frame we
              // found in this view
              if (apiDash.frames[b].id === newFrames.diff(oldFrames)[0]){

                // push that frame to the local scope. since the changes are
                // automatically binded with the view, no refresh
                $scope.frames.push(
                  apiDash.frames[b]
                );
                // update the frame size so it fits inside its little widget
                // boundary
                // $scope.updateGridFrameSize(apiDash.frames[b].id);
                // now quickly merge my local scope for frames with the
                // marketplace api to get important stuff on local scope like
                // url, image, name, etc
                dashboardApi.mergeApplicationData($scope.frames, $scope.apps);
              }
            }
          }
        }
      }).catch(function(error) {
        console.log(&#x27;should not have happened: &#x27; + error);
      });
    }

    /**
     * Update the active dashboard and broadcast dashboardStateChangedEvent on
     * completion
     *
     * @method updateDashboard
     */
    function updateDashboard() {
      if (!$scope.dashboards) {
        console.log(&#x27;Dashboard changed, but no dashboards exist&#x27;);
        return;
      }
      var dashboardId = dashboardChangeMonitor.dashboardId;
      for (var i=0; i &lt; $scope.dashboards.length; i++) {
        if ($scope.dashboards[i].id.toString() === dashboardId) {
          $scope.currentDashboard = $scope.dashboards[i];
          $scope.currentDashboardId = $scope.currentDashboard.id;
          $scope.frames = $scope.currentDashboard.frames;

          // Merge application data (app name, icons, descriptions, url, etc)
          // with dashboard app data
          dashboardApi.mergeApplicationData($scope.frames, $scope.apps);

          $scope.max = {};

          sortFrames();

          for (var k = 0, len = $scope.frames.length; k &lt; len; k++) {
            $scope.frames[k].desktopLayout.zIndex = k;
          }
          $scope.max.zIndex = $scope.frames.length - 1;
        }
      }

      // $scope.activeFrames = $scope.currentDashboard.frames;
      $rootScope.$broadcast(dashboardStateChangedEvent);
    }

    /**
     * Getter for frame.isMinimized
     *
     * @method isFrameMinimized
     * @param e Frame to get data for
     * @returns {boolean}
     */
    $scope.isFrameMinimized = function(e) {
      for (var i=0; i &lt; $scope.frames.length; i++) {
        if ($scope.frames[i].id === e.id) {
          return $scope.frames[i].isMinimized;
        }
      }
    };

    /**
     * Getter for frame.isMaximized
     *
     * @method isFrameMaximized
     * @param e Frame to get data for
     * @returns {boolean}
     */
    $scope.isFrameMaximized = function(e) {
      for (var i=0; i &lt; $scope.frames.length; i++) {
        if ($scope.frames[i].id === e.id) {
          return $scope.frames[i].isMaximized;
        }
      }
    };

    /**
     * Sort the zIndex of all frames
     *
     * @method sortFrames
     */
    function sortFrames() {
      $scope.frames.sort(function(a, b) {
        return ((a.desktopLayout.zIndex &lt; b.desktopLayout.zIndex) ? -1 :
          ((a.desktopLayout.zIndex &gt; b.desktopLayout.zIndex) ? 1 : 0));
      });
    }
  });
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
