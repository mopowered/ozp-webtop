<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/app/dashboardView/grid/grid.js - ozpwebtop</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="ozpwebtop"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/components.ozpButton.html">components.ozpButton</a></li>
            
                <li><a href="../classes/components.ozpIcon.html">components.ozpIcon</a></li>
            
                <li><a href="../classes/controllers.GridController.html">controllers.GridController</a></li>
            
                <li><a href="../classes/dashboardView.IframeController.html">dashboardView.IframeController</a></li>
            
                <li><a href="../classes/directives.gridsterItem.html">directives.gridsterItem</a></li>
            
                <li><a href="../classes/directives.ozpGridster.html">directives.ozpGridster</a></li>
            
                <li><a href="../classes/directives.ozpManagedFrame.html">directives.ozpManagedFrame</a></li>
            
                <li><a href="../classes/general.elliptical.html">general.elliptical</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/ozpWebtopApp.html">ozpWebtopApp</a></li>
            
                <li><a href="../modules/ozpWebtopApp.apis.html">ozpWebtopApp.apis</a></li>
            
                <li><a href="../modules/ozpWebtopApp.appToolbar.html">ozpWebtopApp.appToolbar</a></li>
            
                <li><a href="../modules/ozpWebtopApp.components.html">ozpWebtopApp.components</a></li>
            
                <li><a href="../modules/ozpWebtopApp.dashboardToolbar.html">ozpWebtopApp.dashboardToolbar</a></li>
            
                <li><a href="../modules/ozpWebtopApp.dashboardView.html">ozpWebtopApp.dashboardView</a></li>
            
                <li><a href="../modules/ozpWebtopApp.general.html">ozpWebtopApp.general</a></li>
            
                <li><a href="../modules/ozpWebtopApp.userSettings.html">ozpWebtopApp.userSettings</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: src/app/dashboardView/grid/grid.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x27;use strict&#x27;;

/**
 * GridController retrieves the state of a number of tiles and binds it to an
 * Angular scope.
 *
 * @namespace controllers
 * @class GridController
 * @constructor
 */
angular.module(&#x27;ozpWebtopApp.dashboardView&#x27;)

.controller(&#x27;GridController&#x27;, function ($scope, $rootScope, $location,
                                        dashboardApi, marketplaceApi,
                                        dashboardChangeMonitor) {

  dashboardChangeMonitor.run();
  $scope.$on(&#x27;dashboardChange&#x27;, function(event, data) {
    $scope.dashboardId = data.dashboardId;
    // console.log(&#x27;grid.js received dashboard change msg: &#x27; + JSON.stringify(data));
  });

  // TODO: Originally tried sending broadcast events from dashboardChangeMonitor,
  // but that did not work out - led to lots of problems such as the desktop
  // and grid controllers not being loaded/unloaded properly. So instead, we&#x27;ll
  // just reach into the internal state of the dashboardChangeMonitor to get
  // this info and use $watch on $location.path to trigger the update. To
  // see what happens, just uncomment the console.logs in $on.(...) in
  // grid.js and desktop.js
  $scope.$watch(function() {
    return $location.path();
  }, function() {
    updateDashboard();
  });

  // invoked whenever the user switches dashboards or changes the dashboard
  // layout
  function updateDashboard() {
    // Get the dashboard
    $scope.dashboardId = dashboardChangeMonitor.dashboardId;
    $scope.dashboard = dashboardApi.getDashboardById($scope.dashboardId);
    // Get frames on this dashboard
    $scope.frames = $scope.dashboard.frames;

    // TODO: There should be a method in Marketplace to get only my apps
    var allApps = marketplaceApi.getAllApps();
    // Merge application data (app name, icons, descriptions, url, etc)
    // with dashboard app data
    dashboardApi.mergeApplicationData($scope.frames, allApps);

    // calculate the size (in px) for each frame and send an update message
    for (var j=0; j &lt; $scope.frames.length; j++) {
      var widgetSize = $scope.updateGridFrameSize($scope.frames[j].id);

        $rootScope.$broadcast(&#x27;gridSizeChanged&#x27;, {
          &#x27;frameId&#x27;: $scope.frames[j].id,
          &#x27;height&#x27;: widgetSize.height,
          &#x27;width&#x27;: widgetSize.width
        });
    }

    $scope.customItemMap = {
      sizeX: &#x27;item.gridLayout.sizeX&#x27;,
      sizeY: &#x27;item.gridLayout.sizeY&#x27;,
      row: &#x27;item.gridLayout.row&#x27;,
      col: &#x27;item.gridLayout.col&#x27;
    };

    // TODO: clean this up
    $rootScope.activeFrames = $scope.frames;
  }

  $scope.$watch(&#x27;frames&#x27;, function(frames){
    // This will be invoked every time a frame is resized (as the cursor
    // moves, not just once when the mouse button is released). So each time
    // a frame is &#x27;temporarily&#x27; resized, this dashboardApi call is made for
    // each app on the dashboard.
    // TODO: This could be a performance issue
    for (var j=0; j &lt; frames.length; j++) {
      dashboardApi.updateGridFrame(frames[j].id, frames[j].gridLayout.row,
        frames[j].gridLayout.col, frames[j].gridLayout.sizeX,
        frames[j].gridLayout.sizeY);
    }
  }, true);

  // TODO: broadcast a message with these grid options so other components
  // have access to the information


  $scope.gridOptions =  {
    columns: 6, // the width of the grid, in columns
    pushing: true, // whether to push other items out of the way on move or resize
    floating: true, // whether to automatically float items up so they stack (you can temporarily disable if you are adding unsorted items with ng-repeat)
    width: &#x27;auto&#x27;, // can be an integer or &#x27;auto&#x27;. &#x27;auto&#x27; scales gridster to be the full width of its containing element
    colWidth: &#x27;auto&#x27;, // can be an integer or &#x27;auto&#x27;.  &#x27;auto&#x27; uses the pixel width of the element divided by &#x27;columns&#x27;
    rowHeight: &#x27;match&#x27;, // can be an integer or &#x27;match&#x27;.  Match uses the colWidth, giving you square widgets.
    margins: [20, 20], // the pixel distance between each widget
    outerMargin: false, // don&#x27;t apply margins to outside of grid
    isMobile: false, // stacks the grid items if true
    minColumns: 1, // the minimum columns the grid must have
    minRows: 1, // the minimum height of the grid, in rows
    maxRows: 10,
    resizable: {
      enabled: true,
      handles: &#x27;n, e, s, w, ne, se, sw, nw&#x27;,
      start: function(event, uiWidget) {
        // reduce the size of the frame when resizing is started so that
        // gridster behaves itself
        var frameId = uiWidget.element.context.id;
        for (var i=0; i &lt; $scope.frames.length; i++) {
          if ($scope.frames[i].id === frameId) {
            // trying to do something smarter here didn&#x27;t work out well - be
            // sure to perform ample testing if these values are changed
            $scope.frames[i].gridLayout.width = 100;
            $scope.frames[i].gridLayout.height = 100;

            $rootScope.$broadcast(&#x27;gridSizeChanged&#x27;, {
              &#x27;frameId&#x27;: frameId,
              &#x27;height&#x27;: 100,
              &#x27;width&#x27;: 100
            });
          }
        }
      }, // optional callback fired when resize is started,
      resize: function(/*event, uiWidget, $element */) {
      }, // optional callback fired when item is resized,
      stop: function(event, uiWidget){
        // The dimensions reported by uiWidget are wrong - use custom function
        // to calculate new size
        var frameId = uiWidget.element.context.id;
        var frameSize = $scope.updateGridFrameSize(frameId);

        // update this frame&#x27;s state to save its size
        dashboardApi.updateFrameSizeOnGrid(frameId, frameSize.width,
          frameSize.height);

        // send the message so the app can adjust their contents appropriately
        $rootScope.$broadcast(&#x27;gridSizeChanged&#x27;, {
          &#x27;frameId&#x27;: frameId,
          &#x27;height&#x27;: frameSize.height,
          &#x27;width&#x27;: frameSize.width
        });
      } // optional callback fired when item is finished resizing
    },
    draggable: {
      enabled: true, // whether dragging items is supported
      handle: &#x27;div.ozp-chrome, div.ozp-chrome &gt; .chrome-icon, div.ozp-chrome &gt; .chrome-name&#x27;, // optional selector for resize handle
      start: function(/*event, uiWidget, $element*/) {}, // optional callback fired when drag is started,
      drag: function(/*event, uiWidget, $element*/) {}, // optional callback fired when item is moved,
      stop: function(/*event, uiWidget, $element*/) {} // optional callback fired when item is finished dragging
    }
  };

  // necessary because the built-in angular-gridster method that calculates a
  // grid tile&#x27;s size after resizing does not yield the correct results.
  $scope.calculateGridFrameSize = function(frameId) {
    // padding on left and right sides of container
    var gridsterContainerPadding = 15;
    var cols = $scope.gridOptions.columns;
    var windowWidth = window.innerWidth;
    var colMargin = $scope.gridOptions.margins[0];
    var totalWorkingWidth = windowWidth - 2*gridsterContainerPadding - (cols-1)*colMargin;
    var baseWidgetWidth = totalWorkingWidth/cols;
    // assume row margins and height are same as for columns
    var baseWidgetHeight = baseWidgetWidth;

    var appInfo = dashboardApi.getFrameById(frameId);
    var sizeX = appInfo.gridLayout.sizeX;
    var sizeY = appInfo.gridLayout.sizeY;
    var widgetWidth = baseWidgetWidth * sizeX + (colMargin*(sizeX-1));
    // Make small adjustment to width
    widgetWidth -= 2*sizeX;
    var widgetHeight = baseWidgetHeight * sizeY + (colMargin*(sizeY-1));
    return {
      &#x27;height&#x27;: widgetHeight,
      &#x27;width&#x27;: widgetWidth
    };
  };

  // Update this instance&#x27;s pixel size
  $scope.updateGridFrameSize = function(frameId) {
    var widgetSize = $scope.calculateGridFrameSize(frameId);
      for (var i=0; i &lt; $scope.frames.length; i++) {
        if ($scope.frames[i].id === frameId) {
          widgetSize.width -= 10;   // for good measure
          widgetSize.height -= 30;  // minus height of chrome
          $scope.frames[i].gridLayout.width = widgetSize.width;
          $scope.frames[i].gridLayout.height = widgetSize.height;

          // update this widget&#x27;s state to save its size
          dashboardApi.updateFrameSizeOnGrid(frameId, widgetSize.width,
            widgetSize.height);
          return widgetSize;
        }
      }
  };

});

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
